<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Keyword Explorer</title>
    <style>
      body { font-family: sans-serif; margin: 0; background: #f3f4f6; color: #111827; }
      nav { background: #111827; padding: 1rem 2rem; display: flex; gap: 1.5rem; flex-wrap: wrap; }
      nav a { color: #d1d5db; text-decoration: none; }
      nav a strong { color: #fff; }
      main { max-width: 1100px; margin: 2.5rem auto; display: grid; gap: 1.5rem; grid-template-columns: minmax(0, 360px) minmax(0, 1fr); }
      section, aside { background: #fff; border-radius: 16px; padding: 1.75rem 2rem; box-shadow: 0 18px 38px rgba(15, 23, 42, 0.12); }
      h1 { margin-top: 0; }
      .form-grid { display: grid; gap: 0.85rem; }
      select { padding: 0.75rem 1rem; border-radius: 10px; border: 1px solid #d1d5db; font-size: 1rem; }
      button.primary { padding: 0.65rem 1.5rem; border-radius: 999px; border: none; background: #2563eb; color: #fff; font-size: 1rem; cursor: pointer; justify-self: start; box-shadow: 0 12px 28px rgba(37,99,235,0.2); transition: transform 0.15s ease, box-shadow 0.2s ease; }
      button.primary:disabled { background: #9ca3af; cursor: not-allowed; box-shadow: none; }
      button.primary:not(:disabled):hover { transform: translateY(-1px); box-shadow: 0 16px 32px rgba(37,99,235,0.26); }
      .keyword-list { display: flex; flex-wrap: wrap; gap: 0.6rem; margin-top: 1.25rem; }
      .keyword-pill { display: inline-flex; align-items: center; gap: 0.45rem; padding: 0.55rem 0.95rem; border-radius: 999px; border: 1px solid #d1d5db; background: #f9fafb; cursor: pointer; font-size: 0.95rem; transition: all 0.2s ease; box-shadow: 0 4px 12px rgba(15, 23, 42, 0.08); }
      .keyword-pill.core { border-color: #1d4ed8; background: #dbeafe; font-weight: 600; }
      .keyword-pill.active { background: #2563eb; border-color: #1e3a8a; color: #fff; box-shadow: 0 10px 28px rgba(37,99,235,0.28); }
      .keyword-pill.generated { border-style: dashed; background: #fef3c7; }
      .keyword-pill:hover { border-color: #2563eb; color: #1d4ed8; }
      .keyword-pill.active:hover { color: #fff; }
      .keyword-count { font-size: 0.8rem; opacity: 0.75; }
      .status-line { color: #6b7280; font-size: 0.9rem; margin-top: 0.65rem; }
      .detail-header { display: flex; justify-content: space-between; align-items: center; gap: 1rem; }
      .detail-header h2 { margin: 0; font-size: 1.4rem; }
      .detail-actions { display: flex; align-items: center; gap: 0.75rem; }
      .save-button { padding: 0.5rem 1.2rem; border-radius: 999px; border: none; background: #2563eb; color: #fff; font-size: 0.95rem; cursor: pointer; box-shadow: 0 10px 24px rgba(37,99,235,0.18); }
      .save-button:disabled { background: #9ca3af; cursor: not-allowed; box-shadow: none; }
      .save-status { font-size: 0.85rem; color: #6b7280; }
      .detail-columns { display: grid; gap: 1.25rem; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); margin-top: 1.5rem; }
      .detail-card { border: 1px solid #e5e7eb; border-radius: 14px; padding: 1rem 1.25rem; background: #f9fafb; box-shadow: 0 10px 24px rgba(15, 23, 42, 0.08); min-height: 180px; display: flex; flex-direction: column; }
      .detail-card h3 { margin: 0 0 0.85rem; font-size: 1.1rem; }
      .candidate-item { margin-bottom: 0.75rem; padding-bottom: 0.75rem; border-bottom: 1px solid #e5e7eb; }
      .candidate-item:last-child { border-bottom: none; margin-bottom: 0; padding-bottom: 0; }
      .candidate-meta { font-size: 0.85rem; color: #4b5563; margin-bottom: 0.35rem; }
      .candidate-snippet { white-space: pre-wrap; font-size: 0.95rem; margin: 0; line-height: 1.45; }
      .definition-item { margin-bottom: 0.65rem; padding: 0.6rem 0.7rem; border-radius: 10px; background: #fff; border: 1px solid #e5e7eb; box-shadow: inset 0 1px 2px rgba(15, 23, 42, 0.05); }
      @media (max-width: 960px) {
        main { grid-template-columns: 1fr; }
      }
    </style>
  </head>
  <body>
    <nav>
      <a href="/">Search</a>
      <a href="/support">Support Agent</a>
      <a href="/knowledge">Knowledge Base</a>
      <a href="/keywords"><strong>Keyword Explorer</strong></a>
    </nav>
    <main>
      <aside>
        <h1>Keyword Explorer</h1>
        <p>Pick a project, run a keyword scan, and inspect core concepts pulled from its knowledge base.</p>
        <div class="form-grid">
          <label for="project">Project</label>
          <select id="project" aria-label="Select project">
            {% for project in projects %}
              <option value="{{ project.id }}" {% if project.id == selected_project %}selected{% endif %}>{{ project.name }}</option>
            {% endfor %}
          </select>
          <button id="keyword-search" class="primary" type="button">Search keywords</button>
          <p id="keyword-status" class="status-line">Select a project and click search to generate keyword candidates.</p>
        </div>
        <div id="keyword-list" class="keyword-list" aria-live="polite"></div>
      </aside>
      <section>
        <div class="detail-header">
          <h2 id="detail-title">Keyword details</h2>
          <div class="detail-actions">
            <span id="detail-subtitle" class="status-line"></span>
            <button id="save-insight" class="save-button" type="button" disabled>Save insight</button>
            <span id="save-status" class="save-status"></span>
          </div>
        </div>
        <div class="detail-columns">
          <div class="detail-card" id="candidate-card">
            <h3>Candidate snippets</h3>
            <div id="candidate-list" aria-live="polite"></div>
          </div>
          <div class="detail-card" id="definition-card">
            <h3>Definitions</h3>
            <div id="definition-list" aria-live="polite"></div>
          </div>
        </div>
      </section>
    </main>
    <script>
      document.addEventListener('DOMContentLoaded', () => {
        const projectSelect = document.getElementById('project');
        const searchButton = document.getElementById('keyword-search');
        const keywordStatus = document.getElementById('keyword-status');
        const keywordList = document.getElementById('keyword-list');
        const detailTitle = document.getElementById('detail-title');
        const detailSubtitle = document.getElementById('detail-subtitle');
        const saveButton = document.getElementById('save-insight');
        const saveStatus = document.getElementById('save-status');
        const candidateList = document.getElementById('candidate-list');
        const definitionList = document.getElementById('definition-list');

        let keywords = [];
        let selectedTerm = null;
        let currentInsight = null;
        let currentFilter = {};

        function clearKeywordList() {
          keywordList.innerHTML = '';
        }

        function clearDetail() {
          candidateList.innerHTML = '<p class="status-line">Pick a keyword to see related snippets.</p>';
          definitionList.innerHTML = '<p class="status-line">Definitions will appear here when available.</p>';
          detailTitle.textContent = 'Keyword details';
          detailSubtitle.textContent = '';
        }

        async function loadKeywords() {
          const projectId = projectSelect.value;
          if (!projectId) {
            keywordStatus.textContent = 'Select a project first.';
            keywordStatus.style.color = '#b91c1c';
            keywordStatus.dataset.status = 'error';
            return;
          }

          searchButton.disabled = true;
          keywordStatus.dataset.status = 'loading';
          keywordStatus.style.color = '#1f2937';
          keywordStatus.textContent = 'Scanning project documents for keywords...';
          clearKeywordList();
          clearDetail();
          selectedTerm = null;
          currentInsight = null;
          saveButton.disabled = true;
          saveStatus.textContent = '';

          try {
            const response = await fetch(`/keywords/${encodeURIComponent(projectId)}/candidates`);
            if (!response.ok) {
              throw new Error(`Failed to fetch keywords (status ${response.status})`);
            }
            const data = await response.json();
            const filterInfo = data.filter || {};
            const status = filterInfo.status || 'unknown';
            currentFilter = filterInfo;
            keywordStatus.dataset.status = status;
            keywordStatus.style.color = '#1f2937';
            keywords = data.keywords || [];

            if (status === 'filtered') {
              const total = filterInfo.candidate_count ?? keywords.length;
              keywordStatus.textContent = `LLM filtered ${total} candidates to ${keywords.length}.`;
            } else if (status === 'bypass') {
              const reason = filterInfo.reason ? ` (reason: ${filterInfo.reason})` : '';
              keywordStatus.textContent = `LLM filtering bypassed${reason}; showing frequency list (${keywords.length}).`;
              keywordStatus.style.color = '#b45309';
            } else if (status === 'error') {
              const reason = filterInfo.reason ? ` (${filterInfo.reason})` : '';
              keywordStatus.textContent = `LLM filtering failed${reason}; showing frequency list (${keywords.length}).`;
              keywordStatus.style.color = '#b91c1c';
            } else {
              keywordStatus.textContent = `Found ${keywords.length} keyword candidate${keywords.length === 1 ? '' : 's'}.`;
            }

            if (!keywords.length) {
              keywordStatus.textContent = 'No keyword candidates detected. Try ingesting more content.';
              keywordStatus.style.color = '#b91c1c';
              return;
            }

            renderKeywordList();
          } catch (error) {
            console.error(error);
            keywordStatus.textContent = 'Unable to load keywords right now. Please try again later.';
            keywordStatus.style.color = '#b91c1c';
            keywordStatus.dataset.status = 'error';
          } finally {
            searchButton.disabled = false;
          }
        }

        function renderKeywordList() {
          clearKeywordList();
          keywords.forEach((item) => {
            const button = document.createElement('button');
            button.type = 'button';
            button.className = 'keyword-pill';
            if (item.core) {
              button.classList.add('core');
            }
            if (item.generated) {
              button.classList.add('generated');
            }
            if (item.term === selectedTerm) {
              button.classList.add('active');
            }
            button.innerHTML = `
              <span class="keyword-term">${item.term}</span>
              <span class="keyword-count">×${item.count}</span>
            `;
            if (item.reason) {
              button.title = item.reason;
            } else if (item.generated) {
              button.title = 'LLM generated keyword';
            } else if (item.source === 'candidate') {
              button.title = 'Frequency candidate retained by LLM';
            }
            button.addEventListener('click', () => selectKeyword(item.term, button));
            keywordList.appendChild(button);
          });
        }

        async function selectKeyword(term, button) {
          if (selectedTerm === term) {
            return;
          }
          selectedTerm = term;
          document.querySelectorAll('.keyword-pill').forEach((pill) => {
            pill.classList.toggle('active', pill === button);
          });
          detailTitle.textContent = `Keyword: ${term}`;
          detailSubtitle.textContent = 'Loading contextual matches...';
          candidateList.innerHTML = '';
          definitionList.innerHTML = '';
          saveStatus.textContent = '';
          saveButton.disabled = true;

          try {
            const projectId = projectSelect.value;
            const response = await fetch(`/keywords/${encodeURIComponent(projectId)}/definition?term=${encodeURIComponent(term)}`);
            if (!response.ok) {
              throw new Error(`Definition lookup failed (status ${response.status})`);
            }
            const data = await response.json();
            const candidates = data.candidates || [];
            const definitions = data.definitions || [];

            renderCandidates(candidates);
            renderDefinitions(definitions);
            detailSubtitle.textContent = `${candidates.length} candidate snippet${candidates.length === 1 ? '' : 's'} • ${definitions.length} glossary definition${definitions.length === 1 ? '' : 's'}`;
            currentInsight = {
              term,
              candidates,
              definitions,
              filter: { ...currentFilter, status: keywordStatus.dataset.status },
            };
            const selectedKeywordMeta = keywords.find((item) => item.term === term);
            if (selectedKeywordMeta) {
              currentInsight.filter.termMeta = selectedKeywordMeta;
            }
            saveButton.disabled = false;
          } catch (error) {
            console.error(error);
            candidateList.innerHTML = '<p class="status-line">Unable to load candidate snippets.</p>';
            definitionList.innerHTML = '<p class="status-line">Unable to load definitions.</p>';
            detailSubtitle.textContent = 'Lookup failed.';
            currentInsight = null;
            saveButton.disabled = true;
          }
        }

        function renderCandidates(candidates) {
          if (!candidates.length) {
            candidateList.innerHTML = '<p class="status-line">No snippets were retrieved for this keyword.</p>';
            return;
          }
          candidateList.innerHTML = '';
          candidates.forEach((candidate) => {
            const wrapper = document.createElement('div');
            wrapper.className = 'candidate-item';

            const meta = document.createElement('div');
            meta.className = 'candidate-meta';
            const parts = [];
            if (candidate.source) {
              parts.push(candidate.source);
            }
            if (typeof candidate.chunk_index === 'number') {
              parts.push(`Chunk ${candidate.chunk_index + 1}`);
            }
            meta.textContent = parts.join(' • ') || 'Snippet';

            const excerpt = document.createElement('pre');
            excerpt.className = 'candidate-snippet';
            excerpt.textContent = candidate.excerpt || candidate.snippet || '';
            if (candidate.snippet && candidate.snippet !== excerpt.textContent) {
              excerpt.title = candidate.snippet;
            }

            wrapper.appendChild(meta);
            wrapper.appendChild(excerpt);
            candidateList.appendChild(wrapper);
          });
        }

        function renderDefinitions(definitions) {
          if (!definitions.length) {
            definitionList.innerHTML = '<p class="status-line">No glossary definitions matched this keyword.</p>';
            return;
          }
          definitionList.innerHTML = '';
          definitions.forEach((definition) => {
            const item = document.createElement('div');
            item.className = 'definition-item';
            item.textContent = definition;
            definitionList.appendChild(item);
          });
        }

        searchButton.addEventListener('click', loadKeywords);
        projectSelect.addEventListener('change', () => {
          keywords = [];
          selectedTerm = null;
          clearKeywordList();
          clearDetail();
          keywordStatus.textContent = 'Select a project and click search to generate keyword candidates.';
          keywordStatus.style.color = '#1f2937';
          keywordStatus.dataset.status = '';
          currentInsight = null;
          currentFilter = {};
          saveButton.disabled = true;
          saveStatus.textContent = '';
        });

        saveButton.addEventListener('click', async () => {
          if (!currentInsight) {
            return;
          }
          const projectId = projectSelect.value;
          saveButton.disabled = true;
          saveStatus.style.color = '#1f2937';
          saveStatus.textContent = 'Saving insight…';
          try {
            const response = await fetch(`/keywords/${encodeURIComponent(projectId)}/insights`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(currentInsight),
            });
            if (!response.ok) {
              throw new Error(`Save failed with status ${response.status}`);
            }
            const data = await response.json();
            saveStatus.style.color = '#047857';
            saveStatus.textContent = `Saved insight (${data.id.slice(0, 6)})`; 
          } catch (error) {
            console.error(error);
            saveStatus.style.color = '#b91c1c';
            saveStatus.textContent = 'Failed to save insight.';
          } finally {
            saveButton.disabled = false;
          }
        });

        clearDetail();
      });
    </script>
  </body>
</html>
