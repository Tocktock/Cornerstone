<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Persona Catalog</title>
    <style>
      body { font-family: sans-serif; margin: 0; background: #f9fafb; color: #111827; }
      nav { background: #111827; padding: 1rem 2rem; }
      nav a { color: #d1d5db; margin-right: 1.5rem; text-decoration: none; }
      nav a strong { color: #fff; }
      main { max-width: 1100px; margin: 2.5rem auto; display: grid; gap: 1.75rem; grid-template-columns: 1.2fr 0.9fr; }
      section, aside { background: #fff; border-radius: 18px; padding: 1.75rem 2rem; box-shadow: 0 18px 42px rgba(15, 23, 42, 0.12); }
      h1, h2 { margin-top: 0; }
      .persona-card { border: 1px solid #e5e7eb; border-radius: 14px; padding: 1.25rem 1.35rem; margin-bottom: 1.1rem; background:#fafbff; box-shadow: inset 0 1px 2px rgba(15,23,42,0.05); }
      .persona-card h3 { margin: 0 0 0.45rem; font-size: 1.1rem; }
      .persona-card p { margin: 0.35rem 0; font-size: 0.92rem; color: #4b5563; }
      .persona-card span { display: block; font-size: 0.85rem; color: #6b7280; }
      .persona-card ul { margin: 0.45rem 0 0; padding-left: 1.1rem; color: #4b5563; font-size: 0.9rem; }
      form { display: grid; gap: 0.65rem; margin-top: 0.75rem; }
      input[type="text"], input[type="url"], textarea { padding: 0.7rem 0.85rem; border-radius: 10px; border: 1px solid #d1d5db; font-size: 0.95rem; }
      textarea { min-height: 90px; resize: vertical; }
      .row { display: grid; gap: 0.65rem; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); }
      .tag-group { display:flex; flex-wrap:wrap; gap:0.4rem; margin-top:0.35rem; }
      .tag { background:#e0e7ff; color:#1d4ed8; padding:0.2rem 0.6rem; border-radius:999px; font-size:0.75rem; }
      button { padding: 0.6rem 1.5rem; border-radius: 999px; border: none; background: #2563eb; color: #fff; font-size: 0.95rem; box-shadow: 0 12px 28px rgba(37, 99, 235, 0.2); cursor: pointer; justify-self: start; }
      button:hover { box-shadow: 0 16px 34px rgba(37, 99, 235, 0.28); }
      .danger { background: #dc2626; box-shadow: 0 12px 28px rgba(220,38,38,0.25); }
      .assigned { margin-top: 0.65rem; font-size: 0.85rem; color: #6b7280; }
      @media (max-width: 980px) {
        main { grid-template-columns: 1fr; }
      }
    </style>
  </head>
  <body>
    <nav>
      <a href="/">Search</a>
      <a href="/support">Support Agent</a>
      <a href="/knowledge">Knowledge Base</a>
      <a href="/keywords">Keyword Explorer</a>
      <a href="/personas"><strong>Personas</strong></a>
    </nav>
    <main>
      <section>
        <h1>Persona Catalog</h1>
        <p>Personas define reusable voice, tone, and guardrails for support agents across projects.</p>
        {% if personas %}
          {% for persona in personas %}
            <div class="persona-card">
              <h3>{{ persona.name }}</h3>
              {% if persona.description %}<p>{{ persona.description }}</p>{% endif %}
              {% if persona.tone %}<span>Tone: {{ persona.tone }}</span>{% endif %}
              {% if persona.system_prompt %}<p style="margin-top:0.4rem; white-space:pre-wrap;">{{ persona.system_prompt }}</p>{% endif %}
              {% if persona.tags %}
                <div class="tag-group">
                  {% for tag in persona.tags %}
                    <span class="tag">{{ tag }}</span>
                  {% endfor %}
                </div>
              {% endif %}
              <div class="assigned">
                {% set projects = assignments.get(persona.id, []) %}
                {% if projects %}
                  In use by: {{ projects | join(', ') }}
                {% else %}
                  Not assigned to any project.
                {% endif %}
              </div>
              <form method="post" action="/personas/{{ persona.id }}">
                <input type="hidden" name="persona_id" value="{{ persona.id }}" />
                <div class="row">
                  <div>
                    <label for="name-{{ persona.id }}">Name</label>
                    <input id="name-{{ persona.id }}" type="text" name="name" value="{{ persona.name }}" required />
                  </div>
                  <div>
                    <label for="tone-{{ persona.id }}">Tone</label>
                    <input id="tone-{{ persona.id }}" type="text" name="tone" value="{{ persona.tone or '' }}" placeholder="e.g. confident and empathetic" />
                  </div>
                </div>
                <label for="description-{{ persona.id }}">Description</label>
                <textarea id="description-{{ persona.id }}" name="description" rows="3" placeholder="Short summary">{{ persona.description or '' }}</textarea>
                <label for="system-{{ persona.id }}">System prompt</label>
                <textarea id="system-{{ persona.id }}" name="system_prompt" rows="4" placeholder="Core instructions" required>{{ persona.system_prompt or '' }}</textarea>
                <label for="avatar-{{ persona.id }}">Avatar URL</label>
                <input id="avatar-{{ persona.id }}" type="url" name="avatar_url" value="{{ persona.avatar_url or '' }}" placeholder="https://..." />
                <label for="tags-{{ persona.id }}">Tags (comma separated)</label>
                <input id="tags-{{ persona.id }}" type="text" name="tags" value="{{ persona.tags | join(', ') }}" placeholder="support, onboarding" />
                <div class="row">
                  <button type="submit">Save Changes</button>
                  <button class="danger" type="submit" name="delete" value="1" {% if assignments.get(persona.id) %}disabled{% endif %}>Delete</button>
                </div>
                {% if assignments.get(persona.id) %}
                  <small style="color:#dc2626; display:block; margin-top:0.35rem;">Detach this persona from all projects before deleting.</small>
                {% endif %}
              </form>
            </div>
          {% endfor %}
        {% else %}
          <p>No personas yet. Create one using the form on the right.</p>
        {% endif %}
      </section>

      <aside>
        <h2>Create Persona</h2>
        <p>Start with a clear description, tone guidance, escalation rules, and any compliance notes.</p>
        <form method="post" action="/personas">
          <label for="new-name">Name</label>
          <input id="new-name" type="text" name="name" placeholder="e.g. Diagnostic Analyst" required />
          <label for="new-description">Description</label>
          <textarea id="new-description" name="description" rows="3" placeholder="How this persona should be used"></textarea>
          <label for="new-tone">Tone</label>
          <input id="new-tone" type="text" name="tone" placeholder="e.g. calm and precise" />
          <label for="new-system">System prompt</label>
          <textarea id="new-system" name="system_prompt" rows="5" placeholder="Instructions the agent should always follow" required></textarea>
          <label for="new-avatar">Avatar URL</label>
          <input id="new-avatar" type="url" name="avatar_url" placeholder="https://..." />
          <label for="new-tags">Tags (comma separated)</label>
          <input id="new-tags" type="text" name="tags" placeholder="support, escalation" />
          <button type="submit">Create Persona</button>
        </form>

        <h2 style="margin-top:2rem;">Guidelines</h2>
        <ul style="padding-left:1.2rem; font-size:0.92rem; color:#4b5563;">
          <li>Personas should include empathy, escalation, and compliance notes.</li>
          <li>Use concise tone descriptors so writers know exactly what voice to adopt.</li>
          <li>Reference canonical docs or product playbooks in the system prompt where useful.</li>
          <li>Encourage human hand-off criteria to prevent unbounded automation.</li>
        </ul>
      </aside>
    </main>
  </body>
</html>
